<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
  <title>Search Workbench</title>
  <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
  <link href="custom.css" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">

  <script>

  </script>

</head>

<!--
Designed and built by Ed Sperr (esperr@uga.edu or ed_sperr@hotmail.com)
-->
<body>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.2/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="venn.js"></script>
<script src="vennframework.js"></script>
<script src="yearframework.js"></script>
<script src="hedges.js"></script>

<div class="container">

<div id="topbanner" class="jumbotron">
  <h1>Search Workbench</h1>
  <a id="about" class="label label-default" href="about.html">About MeSH Category Graph</a>
</div>

<div class="row">

<!--<form id="search">
    <input id="pmsearch" type="text" />
    <input id="runsearch" type="button" value="Search by category" />
</form>
-->

<div id="left" class="col-sm-12 col-md-10 col-lg-9">

<div id="search" class="input-group input-group-lg">
  <input type="text" id="pmsearch" class="form-control">
  <span class="input-group-btn">
    <button id="runsearch" class="btn btn-default" type="button">Search</button>
  </span>

</div>

<div id="translation">
  <div id="splash">
    <p>Don't Enter your MEDLINE search above, and MeSH Category Graph will show how the concepts in your results stack up against the <a href="https://www.nlm.nih.gov/bsd/disted/meshtutorial/meshtreestructures/">16 top-level categories</a>
      in the MeSH hierarchy. For each search you'll see <em>two</em> graphs &mdash; one showing percentages compared to those for
      all of MEDLINE and another showing relative proportion. Once you have completed at least two searches, you can <em>compare</em> the proportions of one search against another. <em><a href="about.html">(more)</a></em></p>
    </div>
</div>


</div>

<div class="col-sm-12 col-md-2 col-lg-3">

<div id="past" class="panel panel-default hideme">
  <div class="panel-heading">
    <h3 class="panel-title">Searches</h3>
  </div>
  <div id="searches" class="panel-body">
  </div>
</div>

</div>


</div>

<div class="row">
  <div class="col-sm-12 col-md-12 col-lg-12">
    <div id="charts">

      <div id="vennpanel" class="panel panel-default hideme">
        <div class="panel-heading">
          <h3 class="panel-title">Venn diagram</h3>
        </div>
        <div class="panel-body">
          <div id="vennresults"></div>
        </div>
      </div>

      <div id="yearpanel" class="panel panel-default hideme">
        <div class="panel-heading">
          <h3 class="panel-title">Proportion by year</h3>
        </div>
        <div class="panel-body">
          <div id="yearresults"></div>
        </div>
      </div>


    </div>
  </div>
</div>

<div id="hedges-list" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title">Hedges</h4>
      </div>
      <div  class="modal-body">
        <form id="hedges" />
      </div>
      <div class="modal-footer">
        <button type="button" id="hedge" class="btn btn-primary">Add Hedge</button>
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

</div>


<footer class="footer">
  <div class="container">
    <span class="text-muted">  <p>Design and contruction by <a href="https://esperr.github.io/about/">Ed Sperr, M.L.I.S.</a>  |
      Data from <a href="http://www.ncbi.nlm.nih.gov/">NCBI</a>  |   Visualization tools from  <a href="https://developers.google.com/chart/interactive/docs/gallery/barchart" target="_blank">Google</a> and
      <a href="https://github.com/benfred/venn.js/" target="_blank">Ben Frederickson</a>
     | See the code at <a href="https://github.com/esperr/search-workbench">GitHub</a></p></span>
  </div>
</footer>


<script>
var searches = {};
var searchkey = 0;
var pubmedURLstem = "https://www.ncbi.nlm.nih.gov/pubmed/?term=";

//var chartwidth = $("#charts").innerWidth() * .9;
var yearwidth = $("#yearresults").innerWidth() * .9;
var vennwidth = $("#vennresults").innerWidth() * .9;

var myyearwidth = 500;
var myyearheight = 250;
if (yearwidth > myyearwidth) {
  myyearwidth = yearwidth;
  myyearheight = yearwidth*.50;
}
$( "#yearresults" ).attr( "style", "max-width: " + yearwidth + "px;" );
$( "#vennresults" ).attr( "style", "max-width: " + vennwidth + "px;" );

google.charts.load('current', {'packages':['line']});

(function() {
//do hedges programatically
for (i=0; i < hedges.length; i++){
  var myvalue = hedges[i].term;
  var myname = hedges[i].name;
  $("#hedges").append('<input type="radio" name="hedge" value="' + myvalue + '"> ' + myname + '<br>')
  }

function handlesearch() {
  var term = $("#pmsearch").val();
  if (!term) {
    return;
  }
  dosearch(term);
  }

//Page actions and behaviors
function showWait() {
  $( "#pmsearch" ).prop( "disabled", true );
  $( "#pmsearch").val("");
  $( "#runsearch" ).prop( "disabled", true );
  $( "form" ).addClass( "hideme" );
  $( "#yearresults").empty();
  $( "#yearresults" ).append("<div id='loading'><p class='text-center'>Grabbing your results &mdash; please wait</p></div>")
  $( "#yearresults p" ).append( '<br /><img src="loading-bars.svg">' );
  }

function showDone() {
  $( "#pmsearch" ).prop( "disabled", false );
  $( "#runsearch" ).prop( "disabled", false );
  $( "form" ).removeClass( "hideme" );
  $( "#runsearch" ).removeClass( "hideme" );
  //$("#loading").remove();
  $("#fetchresults").remove();
  }

$( "#past" ).on( "click", ".pastsearch", function() {
  //while (sets.length) { sets.pop(); }
  var searchIndex = $(this).data("searchIndex");
  showCurrentSearch(searchIndex);
  //console.log(JSON.stringify(searches[searchIndex].vennsets));
  drawYearChart([searchIndex]);
  if (searches[searchIndex].vennsets.length < 1) {
    $("#vennresults").empty();
    $("#vennresults").append('<p class="vennMsg">Only one valid term entered.</p>');
  } else {
    sets = searches[searchIndex].vennsets.slice(0);
    drawVennDiagram();
  }
  });

//Modifying a search and running it again
$( "#translation" ).on( "click", "#searchedits", function() {
    $( "#search" ).toggle();
    var newterm = $("#translationtext").text();
    dosearch(newterm);
  });

$( "#translation" ).on( "click", "#canceledits", function() {
    $( "#search" ).toggle();
    var searchIndex = $("[name=nickname]").data("searchIndex");
    showCurrentSearch(searchIndex);
  });

$( "#translation" ).on( "click", "#showedit", function() {
    $( "#search" ).toggle();
    $( "#showedit" ).toggle();
    $( "#yourterm" ).toggle();
    $( "#count" ).toggle();
    $('#translationtext').attr('contenteditable','true');
    $('#translationtext').addClass( "editing" );
    $("#translationtext").after('<br /><button id="searchedits" type="button" class="btn btn-primary">Run this search</button>');
    $("#searchedits").after(' <button id="hedgeslink" type="button" class="btn btn-primary" data-toggle="modal" data-target="#hedges-list">Add a Hedge</button>');
    $("#hedgeslink").after(' <button id="canceledits" type="button" class="btn btn-danger">Cancel</button>');
    });

$( "#translation" ).on( "click", "#nicknameit", function() {
    var searchIndex = $("[name=nickname]").data("searchIndex");
    if ( $("input[name='nickname']")) {
      nickname = $("input[name='nickname']");
      searches[searchIndex].nickname = $("input[name='nickname']").val();
      showSearches();
      showCurrentSearch(searchIndex);
     }
    });

$( "#translation" ).on( "click", "#deleteme", function() {
    var searchIndex = $("[name=nickname]").data("searchIndex");
    delete searches[searchIndex];
    alert("Search deleted");
    showSearches();
    $( "#translation" ).hide();
    });

//$( "#translation" ).on( "click", "#hedgeslink", function() {
//    $('#hedges-list').modal();
//    });

$( "#hedge" ).click(function() {
    var selHedge = $('input[name=hedge]:checked').val();
    var prehedge = $("#translationtext").text();
    var hedgesearch = prehedge + " AND " + selHedge;
    $('#hedges-list').modal('hide');
    dosearch(hedgesearch);
   });

$( "#past" ).on( "click", "#showcompare", function() {
    $("#past input[name='term']").toggle();
    $("#showcompare").toggle();
    $("#past dl").after('<input id="compare" type="button" value="Compare" /><p style="margin-top: 1em;"><a href="#!" class="showsearches">(go back to search list)</a></p>')
    });

$( "#past" ).on( "click", "#compare", function() {
    var comparisons = [];
    //var compareterms = [];
    $( "input[name='term']" ).each(function( index ) {
      if (this.checked) {
          comparisons.push( $( this ).val() );
        }
      });
      showComparisons(comparisons);
      compVenn(comparisons);
      drawYearChart(comparisons);
    });

$( "#past" ).on( "click", ".showsearches", function() {
    showSearches();
    });

//Searching...
function showSearches() {
  var maxheight = $(".row").first().height() * .8;
  console.log(maxheight);
  var searchname;
  $( "#searches" ).empty();
  $( "#past" ).removeClass( "hideme" );
  $( "#searches" ).attr( 'style', 'max-height:' + maxheight + 'px' );
  //$( "#past" ).append("<div class='panel-heading'>");
  //$( "#past div" ).append("<h3 class='panel-title'>Searches</h3>");
  $( "#searches" ).append("<dl>");
  for (var key in searches) {
    if (searches.hasOwnProperty(key)) {
      if (searches[key].nickname) {
        searchname = '"' + searches[key].nickname + '"';
      } else {
        searchname =  searches[key].term;
      }
      $("#searches dl").append('<dt class="pastsearch"><input type="checkbox" name="term" id="' + key + '" value="' + key + '"> <a href="#!">' + searchname + "</a></dt>");
      $("#searches dt").last().append(": " + searches[key].count );
      $("#searches dt").last().data("searchIndex", key);
    }
  }
  $("#past input[name='term']").toggle();
  if ($("#searches dt").last().data("searchIndex") > 0) {
    $("#searches dl").after('<input id="showcompare" type="button" value="Compare searches" />')
  }
 }

//...and displaying results
function showCurrentSearch(searchkey) {
  currentSearch = searches[searchkey];
  $( "#translation" ).show();
  $( "#translation" ).empty();
  $( "#translation" ).append('<p id="yourterm">Your search:</p>');
  $( "#yourterm" ).append("'" + currentSearch.term + "'");
  if (currentSearch.nickname) {
    $( "#yourterm" ).append(' (alias "' + currentSearch.nickname + '")');
  }
  var pmurl = pubmedURLstem + encodeURI(currentSearch.term);
  $( "#yourterm" ).append('<span id="count"> found <a href="' + pmurl + '" target="_pmresults">' + currentSearch.count + '</a> results</span>');
  $( "#yourterm" ).append('&nbsp; <a href="' + pmurl +'" " target="_blank"><span class="glyphicon glyphicon-new-window"></span></a>');
  $( "#translation" ).append('<p>Was translated to:</p>');
  $( "#translation" ).append("<div id='translationtext'>");
  var newtranslation = fieldstyle(currentSearch.translation);
  $( "#translationtext" ).append(newtranslation);
  $( "#translation" ).append('<br /><button id="showedit" type="button" class="btn btn-warning">Edit this search</button>');
  $("#translation").append("<span id='nickname'>Add a nickname for this search: <input type='text' name='nickname'> <button id='nicknameit' type='button' class='btn btn-primary'>Add</button></span>");
  $("[name=nickname]").data("searchIndex", searchkey);
  $("#showedit").after(' <button id="deleteme" type="button" class="btn btn-danger">Delete this search</button>');
  shareLinks([currentSearch.term]);
}

function showComparisons(comparisons) {
  $( "#translation" ).empty();
  $( "#translation" ).append('<p id="yourterm">Now comparing:</p><ul />');
  var shareterms = [];
  var pmurl;
  for (i=0; i<comparisons.length; i++) {
    if (searches[comparisons[i]].nickname) {
      $( "#translation ul" ).append('<li>"' + searches[comparisons[i]].nickname + '"</li>');
    } else {
      $( "#translation ul" ).append("<li>" + searches[comparisons[i]].term + "</li>");
    }
    pmurl = pubmedURLstem + encodeURI(searches[comparisons[i]].term);
    $( "li" ).last().append('<span id="count"> &mdash; <a href="' + pmurl + '" target="_pmresults"">' + searches[comparisons[i]].count + '</a>');
    $( "li" ).last().append('&nbsp; <a href="' + pmurl +'" " target="_blank"><span class="glyphicon glyphicon-new-window"></span></a>');
    shareterms.push(searches[comparisons[i]].term);
  }
  shareLinks(shareterms);
}

function fieldstyle(transtext) {
  var leftbracket = transtext.replace(/\[/g, '<span class="field">[');
  var rightbracket = leftbracket.replace(/\]/g, ']</span>');
  return rightbracket;
  }

function shareLinks(terms) {
  $( ".sharelink" ).remove();
  var vennlinkbase = "https://pubvenn.appspot.com/?";
  var yearlinkbase = "https://esperr.github.io/pubmed-by-year/?";
  var vennqstr = "";
  var yearqstr = "";
  if (terms.length == 1) {
    vennqstr = terms[0];
    yearqstr = "q1=" + terms[0];
  } else {
    for (i=0; i<terms.length; i++) {
      yearqstr += "q" + Number(i+1).toString() + "=" + terms[i];
      vennqstr += "(" + terms[i] + ")";
      if (i > -1 && i < terms.length-1) {
        vennqstr += " AND ";
        yearqstr += "&";
      }
    }
  }
  var yearshare = yearlinkbase + yearqstr;
  var vennshare = vennlinkbase + vennqstr;
  $( "#yearresults" ).after('<p class="sharelink"><a href="' + yearshare + '" target="_blank">See more on Pubmed by Year</a>')
  $( "#vennresults" ).after('<p class="sharelink"><a href="' + vennshare + '" target="_blank">See more on PubVenn</a>')
}

 //If something goes wrong, we start over
 function startOver() {
   //$("#loading").remove();
   alert("Something bad happened when we called the API...");
   searches.pop();
   showDone();
   //handlesearch();
   }


function dosearch(term) {
  showWait();
  $.ajax({
    url: 'https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esearch.fcgi',
    error: function () {
      startOver();
      return;
    },
    data: {
    db: 'pubmed',
    usehistory: 'y',
    term: term ,
    retmode: 'json',
    retmax: 0,
    email: 'ed_sperr@hotmail.com',
    tool: 'pmsearchbench'
    },
    success: function( data ) {
      // e.g. filter the response
      if (!data.esearchresult.count) {
        //if there's no count  we have to start over
        startOver();
        return;
      }
      if (data.esearchresult.count == "0") {

        $("#translation").prepend('<div class="alert alert-danger" role="alert">Nothing found for this search. Please try again</div>');
        showDone();
        return;
      } else {
      var nickname = "";
      if ( $("input[name='nickname']")) { nickname = $("input[name='nickname']").val(); }

      search = {
        'term': term,
        'count': data.esearchresult.count,
        'translation': data.esearchresult.querytranslation,
        'nickname': nickname
      };
      searches[searchkey] = search;

      showDone();
      showSearches();
      if (data.esearchresult.count < 500) {
        $("#yearresults").empty();
        $("#yearresults").append('Your search only retrieved <strong>' + data.esearchresult.count + '</strong> results. PubMed by Year can only graph searches that have at least 500 results in total.');
        searches[searchkey].yearcounts = "none";
      } else {
        yearsearch(searchkey, term);
      }
      startVenn(searchkey, term);
      showCurrentSearch(searchkey);
      searchkey++;
      if (searchkey == 1) {
        $( "#vennpanel" ).removeClass( "hideme" )
        $( "#yearpanel" ).removeClass( "hideme" )
      }
      //showTranslation(data.esearchresult.querytranslation);
      }
    }
  });
}

$("#runsearch").click(function(){
    handlesearch();
  });

$(document).keypress(function(e) {
if(e.which == 13) {
    //Because both IE and FF now "helpfully" ignore the spec and treat 'button' the same as 'submit'
    e.preventDefault();
    handlesearch();
  }
});

$(".close").click(function(){
  $("#printable").css("display", "none");
      });

$(document).click(function(event) {
   var closeit = document.getElementById('printable');
   if (event.target == closeit) {
      $("#printable").css("display", "none");
      }
      });
})

();
</script>

</body>
</html>
